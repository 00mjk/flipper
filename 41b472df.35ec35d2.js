(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{177:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return a})),t.d(n,"metadata",(function(){return l})),t.d(n,"rightToc",(function(){return p})),t.d(n,"default",(function(){return c}));var r=t(2),i=t(11),o=(t(0),t(233)),a={id:"testing",title:"Testing"},l={id:"extending/testing",title:"Testing",description:"Developer tools are only used if they work. We have built APIs to test plugins.",source:"@site/../docs/extending/testing.mdx",permalink:"/docs/extending/testing",editUrl:"https://github.com/facebook/flipper/blob/master/website/../docs/extending/testing.mdx",sidebar:"extending",previous:{title:"Error Handling",permalink:"/docs/extending/error-handling"},next:{title:"Debugging",permalink:"/docs/extending/debugging"}},p=[{value:"Android",id:"android",children:[]},{value:"C++",id:"c",children:[]},{value:"Testing the Flipper Desktop Plugin",id:"testing-the-flipper-desktop-plugin",children:[]}],s={rightToc:p};function c(e){var n=e.components,t=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},s,t,{components:n,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Developer tools are only used if they work. We have built APIs to test plugins."),Object(o.b)("h2",{id:"android"},"Android"),Object(o.b)("p",null,"Start by creating your first test file in this directory ",Object(o.b)("inlineCode",{parentName:"p"},"MyFlipperPluginTest.java"),". In the test method body we create our plugin which we want to test as well as a ",Object(o.b)("inlineCode",{parentName:"p"},"FlipperConnectionMock"),". In this contrived example we simply assert that our plugin's connected status is what we expect."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-java"}),"@RunWith(RobolectricTestRunner.class)\npublic class MyFlipperPluginTest {\n\n  @Test\n  public void myTest() {\n    final MyFlipperPlugin plugin = new MyFlipperPlugin();\n    final FlipperConnectionMock connection = new FlipperConnectionMock();\n\n    plugin.onConnect(connection);\n    assertThat(plugin.connected(), equalTo(true));\n  }\n}\n")),Object(o.b)("p",null,"There are two mock classes that are used to construct tests ",Object(o.b)("inlineCode",{parentName:"p"},"FlipperConnectionMock")," and ",Object(o.b)("inlineCode",{parentName:"p"},"FlipperResponderMock"),". Together these can be used to write very powerful tests to verify the end to end behavior of your plugin. For example we can test if for a given incoming message our plugin responds as we expect."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-java"}),'@Test\npublic void myTest() {\n  final MyFlipperPlugin plugin = new MyFlipperPlugin();\n  final FlipperConnectionMock connection = new FlipperConnectionMock();\n  final FlipperResponderMock responder = new FlipperResponderMock();\n\n  plugin.onConnect(connection);\n\n  final FlipperObject params = new FlipperObject.Builder()\n      .put("phrase", "flipper")\n      .build();\n  connection.receivers.get("myMethod").onReceive(params, responder);\n\n  assertThat(responder.successes, hasItem(\n      new FlipperObject.Builder()\n          .put("phrase", "ranos")\n          .build()));\n}\n')),Object(o.b)("h2",{id:"c"},"C++"),Object(o.b)("p",null,"Start by creating your first test file in this directory ",Object(o.b)("inlineCode",{parentName:"p"},"MyFlipperPluginTests.cpp")," and import the testing utilities from ",Object(o.b)("inlineCode",{parentName:"p"},"fbsource//xplat/sonar/xplat:FlipperTestLib"),". These utilities mock out core pieces of the communication channel so that you can test your plugin in isolation."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"#include <MyFlipperPlugin/MyFlipperPlugin.h>\n#include <FlipperTestLib/FlipperConnectionMock.h>\n#include <FlipperTestLib/FlipperResponderMock.h>\n\n#include <folly/json.h>\n#include <gtest/gtest.h>\n\nnamespace facebook {\nnamespace flipper {\nnamespace test {\n\nTEST(MyFlipperPluginTests, testDummy) {\n  EXPECT_EQ(1 + 1, 2);\n}\n\n} // namespace test\n} // namespace flipper\n} // namespace facebook\n")),Object(o.b)("p",null,"Here is a simple test using these mock utilities to create a plugin, send some data, and assert that the result is as expected."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'TEST(MyFlipperPluginTests, testDummy) {\n  std::vector<folly::dynamic> successfulResponses;\n  auto responder = std::make_unique<FlipperResponderMock>(&successfulResponses);\n  auto conn = std::make_shared<FlipperConnectionMock>();\n\n  MyFlipperPlugin plugin;\n  plugin.didConnect(conn);\n\n  folly::dynamic message = folly::dynamic::object("param1", "hello");\n  folly::dynamic expectedResponse = folly::dynamic::object("response", "Hi there");\n\n  auto receiver = conn->receivers_["someMethod"];\n  receiver(message, std::move(responder));\n\n  EXPECT_EQ(successfulResponses.size(), 1);\n  EXPECT_EQ(successfulResponses.back(), expectedResponse);\n}\n')),Object(o.b)("h2",{id:"testing-the-flipper-desktop-plugin"},"Testing the Flipper Desktop Plugin"),Object(o.b)("p",null,"Tests should be put in the ",Object(o.b)("inlineCode",{parentName:"p"},"__tests__")," directory of your plugin sources, and be created using Jest.\nAn example test suite can be found ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/facebook/flipper/blob/master/desktop/plugins/layout/__tests__/ProxyArchiveClient.node.tsx"}),"here"),"."),Object(o.b)("p",null,"Flipper exposes an API to generate unit tests that can verify ",Object(o.b)("em",{parentName:"p"},"regressions")," and real life scenarios.\nTo generate a unit test:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Start flipper."),Object(o.b)("li",{parentName:"ol"},"Open your plugin."),Object(o.b)("li",{parentName:"ol"},"Open the Developer Tools (",Object(o.b)("inlineCode",{parentName:"li"},"View > Open Developer Tools"),")."),Object(o.b)("li",{parentName:"ol"},"In the console, call the function ",Object(o.b)("inlineCode",{parentName:"li"},"flipperStartPluginRecording()"),"."),Object(o.b)("li",{parentName:"ol"},"Interact with your application, in such a way that new events are created for your plugin."),Object(o.b)("li",{parentName:"ol"},"Once you generated an interesting amount and diversity of events, call ",Object(o.b)("inlineCode",{parentName:"li"},"flipperStopPluginRecording()")," from the Flipper console."),Object(o.b)("li",{parentName:"ol"},"This process will have generated a unit test and a snapshot file with the data (the console will report where). Move those files to your ",Object(o.b)("inlineCode",{parentName:"li"},"__tests__")," directory."),Object(o.b)("li",{parentName:"ol"},"The unit test should succeed if it is run using Jest. Feel free to modify the unit test to your needs. In the future you might want to record new snapshot data files if the plugin changes.")))}c.isMDXComponent=!0},233:function(e,n,t){"use strict";t.d(n,"a",(function(){return u})),t.d(n,"b",(function(){return m}));var r=t(0),i=t.n(r);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=i.a.createContext({}),c=function(e){var n=i.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l({},n,{},e)),t},u=function(e){var n=c(e.components);return i.a.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},b=Object(r.forwardRef)((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,a=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),u=c(t),b=r,m=u["".concat(a,".").concat(b)]||u[b]||d[b]||o;return t?i.a.createElement(m,l({ref:n},s,{components:t})):i.a.createElement(m,l({ref:n},s))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,a=new Array(o);a[0]=b;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:r,a[1]=l;for(var s=2;s<o;s++)a[s]=t[s];return i.a.createElement.apply(null,a)}return i.a.createElement.apply(null,t)}b.displayName="MDXCreateElement"}}]);