name: Publish Pods
on:
  push:
      branches:
      - auto-podfile-update

jobs:
  publish_flipper_pod:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install Dependences
      run: pod repo update

    - name: Pod Version
      run: pod --version

    - name: Push Flipper
      run: pod trunk push Flipper.podspec --use-libraries --allow-warnings --verbose --skip-import-validation
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

  publish_flipperkit_pod:
    needs: publish_flipper_pod
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install Dependences
      run: pod repo update

    - name: Pod Version
      run: pod --version

    - name: Push FlipperKit
      run: |
        # Retry publishing FlipperKit 5 times. Putting this hack unless we have cocoapods 1.10. More information related to the bug https://github.com/CocoaPods/CocoaPods/issues/9502#issuecomment-579486258
        for i in {1..5}; do pod trunk push FlipperKit.podspec --use-libraries --allow-warnings --verbose --skip-import-validation && break || sleep 20; done
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

  commit_podfile_lock:
      runs-on: macos-latest
      steps:
      - uses: actions/checkout@v2
      - name: Install Dependencies
        run: pod repo update

      - name: Pod Version
        run: pod --version

      # - name: Update Sample's Podfile.lock
      #   run: |
      #       cd Sample/
      #       pod update
      #       ls
      # - name: Update SampleSwift's Podfile.lock
      #   run: |
      #       cd SampleSwift/
      #       pod update
      #       ls
      - name: Update Tutorial's Podfile.lock
        run: |
            cd iOS/Tutorial/
            pod update
            ls
      - name: Git status
        run: |
            git status
      - name: Git diff
        run: |
            git diff
      - name: Git branch
        run: |
            git branch
      - name: Git remote
        run: |
            git remote -v
      - name: Remove Pods
        run: rm -rf iOS/Tutorial/Pods
      - name: Fetch branches
        run: |
            git fetch origin auto-podfile-update
      - name: Checkout to that branch
        run: |
            git checkout auto-podfile-update
      - name: Check current branch
        run: |
            git branch
      # - name: Pull origin
      #   run: |
      #       git pull origin bot-update-podfile-lock-DO-NOT-USE --allow-unrelated-histories || exit 0
      # - name: log yml file
      #   run: ls && cat .github/workflows/publish-pods.yml
      # - name: Turn warning off
      #   run: git config core.autocrlf true
      - name: Set username
        run: |
          git config --global user.name 'Pritesh Nandgaonkar'
          git config --global user.email 'prit91@fb.com'
      - name: Create PR to Update Podfile.lock
        uses: peter-evans/create-pull-request@v2
        with:
          title: 'Automated: Update Podfile.lock'
          body: |
            This is an automated PR to update the Podfile.lock.
            - Make sure that the Podfile.lock contains latest FlipperKit and Flipper pod versions
            - This is auto-generated by [create-pull-request][1]
            [1]: https://github.com/peter-evans/create-pull-request
          base: 'master'
          branch-suffix: short-commit-hash
          committer: 'Pritesh Nandgaonkar <prit91@fb.com>'
          author: 'Pritesh Nandgaonkar <prit91@fb.com>'
          labels: automated pr
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # - name: Add and Commit the files
      #   uses: EndBug/add-and-commit@v4
      #   with:
      #     author_name: Github Action Bot
      #     author_email: githubbot@example.com
      #     force: true
      #     add: '*/Podfile.lock'
      #     cwd: '.'
      #     message: 'Automated Commit: Update Podfile.lock'
      #     ref: bot-update-podfile-lock-DO-NOT-USE
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
